// Code generated by icomplie. DO NOT EDIT!

import { HttpClient } from './httpClient';

export interface WxRequestConfig {
  baseURL: string;
  timeout?: number;
  header?: Record<string, string>;
}

export class WxHttpClient implements HttpClient {
  private config: WxRequestConfig;

  constructor(config: WxRequestConfig) {
    this.config = config;
  }

  private request<T>(options: WechatMiniprogram.RequestOption): Promise<T> {
    return new Promise((resolve, reject) => {
      wx.request({
        ...options,
        success: (res) => {
          if (res.statusCode >= 200 && res.statusCode < 300) {
            resolve(res.data as T);
          } else {
            reject(new Error(`Request failed with status ${res.statusCode}`));
          }
        },
        fail: (err) => {
          reject(err);
        },
      });
    });
  }

  async doPost<T>(url: string, body?: any, headers?: Record<string, string>): Promise<T> {
    return this.request<T>({
      url: this.config.baseURL + url,
      method: 'POST',
      data: body,
      header: {
        'Content-Type': 'application/json',
        ...this.config.header,
        ...headers,
      },
      timeout: this.config.timeout,
    });
  }

  async doGet<T>(url: string, headers?: Record<string, string>): Promise<T> {
    return this.request<T>({
      url: this.config.baseURL + url,
      method: 'GET',
      header: {
        ...this.config.header,
        ...headers,
      },
      timeout: this.config.timeout,
    });
  }

  async doPut<T>(url: string, body?: any, headers?: Record<string, string>): Promise<T> {
    return this.request<T>({
      url: this.config.baseURL + url,
      method: 'PUT',
      data: body,
      header: {
        'Content-Type': 'application/json',
        ...this.config.header,
        ...headers,
      },
      timeout: this.config.timeout,
    });
  }

  buildUrl(basePath: string, params: Record<string, string | number>): string {
    const queryParts: string[] = [];
    Object.entries(params).forEach(([key, value]) => {
      queryParts.push(`${encodeURIComponent(key)}=${encodeURIComponent(String(value))}`);
    });
    const queryString = queryParts.join('&');
    return queryString ? `${basePath}?${queryString}` : basePath;
  }
}
